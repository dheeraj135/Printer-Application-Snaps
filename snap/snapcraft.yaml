name: foomatic-printer-application # you probably want to 'snapcraft register <name>'
base: core18 # the base snap is the execution environment for this snap
version: '0.0.2' # just for humans, typically '1.2+git' or '1.3.2'
summary: Snap for Foomatic Printer driver packages. # 79 char long summary
description: |
  This snap aims to provide modular snaps for Foomatic printer driver package.

grade: devel # must be 'stable' to release into candidate/stable channels
confinement: strict # use 'strict' once you have the right plugs and slots

apps:
  run-server:
    command: bin/server
    daemon: simple
    environment:
     GS_LIB: "/snap/$SNAP_NAME/current/usr/share/ghostscript/9.26/Resource/Init"
     PYTHONPATH: "/snap/$SNAP_NAME/current/lib/python2.7/site-packages/"     
     PERL5LIB: "/snap/$SNAP_NAME/current/usr/share/perl/5.26.1/:/snap/$SNAP_NAME/current/usr/lib/x86_64-linux-gnu/perl5/5.26/\
     :/snap/$SNAP_NAME/current/usr/share/perl5/:/snap/$SNAP_NAME/current/usr/lib/x86_64-linux-gnu/perl/5.26/"
     FOOMATICDB: "/snap/$SNAP_NAME/current/share/foomatic"
     FOOMATICBIN: "/snap/$SNAP_NAME/current/bin"
    plugs: 
    -  network 
    -  network-bind
    -  avahi-control
    -  raw-usb
    -  home
    -  hardware-observe
  run-deviced:
    command: bin/deviced
    environment:
      PYTHONPATH: "/snap/$SNAP_NAME/current/lib/python2.7/site-packages/"
      SNAP_BACKENDS: "hp,hpfax"
    plugs: 
    -  network 
    -  network-bind
    -  avahi-control
    -  raw-usb
    -  home
    -  hardware-observe
  run-ippprint:
    command: bin/ippprint
    environment:
     GS_LIB: "/snap/$SNAP_NAME/current/usr/share/ghostscript/9.26/Resource/Init"

  run-ippeveprinter:
    command: bin/ippeveprinter
    environment:
     GS_LIB: "/snap/$SNAP_NAME/current/usr/share/ghostscript/9.26/Resource/Init"
    plugs: [network, network-bind, avahi-control, raw-usb]

parts:
  ippsample:
    plugin: autotools
    source: https://github.com/dheeraj135/ippsample.git
    configflags:
      - --datarootdir=/usr/share/
    build-packages:
    - libcups2-dev
    - zlib1g
    - liblzma5
    stage:
      - -lib/libcups.a
    # organize: 
    #   lib/libcups.a : lib/cups/

  server:
    # See 'snapcraft plugins'
    plugin: autotools
    #source: https://github.com/dheeraj135/Printer-Applications-Framework.git
    source: ./Printer-Applications-Framework/
    source-type: git
    build-packages:
      - libcups2
      - libcups2-dev
      - perl
      - automake
      - autoconf
      - m4
      - libudev-dev
      - libavahi-client-dev
      - libavahi-common-dev
      - libavahi-common3
      - libavahi-client3
      - libgnutls28-dev

    stage-packages:
      - libcups2
      - libavahi-common3
      - libavahi-client3
      - udev

    override-build: |
      autoreconf
      snapcraftctl build

    after: [ippsample]
  
  cups-filters:
    plugin: dump
    source: ./temp
    stage-packages:
    - cups-filters
    - cups
    prime:
    - usr/lib/cups/filter/
    - usr/share/cups/mime/
    - usr/lib/cups/backend/
    - -usr/lib/cups/backend/driverless
    - -usr/lib/cups/backend/cups-brf
    - etc/cups/snmp.conf
    - usr/share/cups/usb/
    stage:
    - usr/lib/cups/filter/
    - usr/share/cups/mime/
    - usr/lib/cups/backend/
    - etc/cups/snmp.conf
    - usr/share/cups/usb/
    organize:
     usr/lib/cups/backend-available/* : usr/lib/cups/backend/

  libraries:
    plugin: dump
    source: ./temp
    prime:
    - .
    stage:
    - .
    stage-packages:
    - libqpdf21
    - libcupsfilters1
    - ghostscript

  foomatic-db:
    plugin: autotools
    #source: https://github.com/openprinting/foomatic-db.git
    source: ./foomatic-db/
    build-packages:
    - perl
    - cups
    - gzip
    stage-packages:
    - perl
    override-build: |
      snapcraftctl build
      rm $SNAPCRAFT_PART_INSTALL/usr/share/cups/model/foomatic-db-ppds
      cd $SNAPCRAFT_PART_INSTALL/usr/share/cups/model && ln -s ../../../../share/foomatic/db/source/PPD/ foomatic-db-ppds
  
  foomatic-db-engine:
    plugin: autotools
    #source: https://github.com/openprinting/foomatic-db-engine.git
    source: ./foomatic-db-engine/
    build-packages:
    - perl
    - gzip
    - cups
    stage-packages:
    - perl
    - libxml2
    - libxml-namespacesupport-perl
    - libxml-sax-perl
    - libxml-libxml-perl
    - perl-base
    - libclone-perl
    - libdbi-perl
    # - libencode-perl
    # - libstorable-perl
    override-build: |
     patch -p0 < ../../../project/foomatic-engine-foomaticbin.patch
     snapcraftctl build
     rm $SNAPCRAFT_PART_INSTALL/usr/lib/cups/driver/foomatic
     cd $SNAPCRAFT_PART_INSTALL/usr/lib/cups/driver/ && ln -s ../../../../bin/foomatic-ppdfile foomatic

# export PERL5LIB=/root/prime/usr/share/perl/5.26:/root/prime/usr/lib/x86_64-linux-gnu/perl5/5.26/:/root/prime/usr/share/perl5/
# export FOOMATICDB=/root/prime/share/foomatic
# export FOOMATICBIN=/root/prime/bin
