name: hplip-printer-application # you probably want to 'snapcraft register <name>'
base: core18 # the base snap is the execution environment for this snap
version: '0.0.2' # just for humans, typically '1.2+git' or '1.3.2'
summary: Snap for HPLIP Printer driver packages. # 79 char long summary
description: |
  This snap aims to provide modular snaps for HPLIP printer driver package.

grade: devel # must be 'stable' to release into candidate/stable channels
confinement: strict # use 'strict' once you have the right plugs and slots

apps:
  run-server:
    command: bin/server
    #daemon: simple
    environment:
     GS_LIB: "/snap/$SNAP_NAME/current/usr/share/ghostscript/9.26/Resource/Init"
     PYTHONPATH: "/snap/$SNAP_NAME/current/lib/python2.7/site-packages/"
     SNAP_BACKENDS: "hp,hpfax"
    plugs: 
    -  network 
    -  network-bind
    -  avahi-control
    -  raw-usb
    -  home
    -  hardware-observe
  run-deviced:
    command: bin/deviced
    environment:
      PYTHONPATH: "/snap/$SNAP_NAME/current/lib/python2.7/site-packages/"
      SNAP_BACKENDS: "hp,hpfax"
    plugs: 
    -  network 
    -  network-bind
    -  avahi-control
    -  raw-usb
    -  home
    -  hardware-observe
  run-ippprint:
    command: bin/ippprint
    environment:
     GS_LIB: "/snap/$SNAP_NAME/current/usr/share/ghostscript/9.26/Resource/Init"
    plugs:
    -  network
    -  network-bind
    -  avahi-control
    -  raw-usb
    -  home
    -  hardware-observe

  run-ippeveprinter:
    command: bin/ippeveprinter
    environment:
     GS_LIB: "/snap/$SNAP_NAME/current/usr/share/ghostscript/9.26/Resource/Init"
    plugs: [network, network-bind, avahi-control, raw-usb]

parts:
  ippsample:
    plugin: autotools
    source: https://github.com/dheeraj135/ippsample.git
    #source: ./ippsample
    # organize:
    #   lib/libcups.a: lib/ippsample/libcups.a
    configflags:
      - --datarootdir=/usr/share/
    build-packages:
    - libcups2-dev
    - zlib1g
    - liblzma5
    - libcups2
    stage:
     - -lib/libcups.a
     - -usr/share/cups/drv/
     - -usr/share/cups/ppdc/
    #  - -usr/share/ipptool/
    after: [cups-filters]

  server:
    # See 'snapcraft plugins'
    plugin: autotools
    #source: https://github.com/dheeraj135/Printer-Applications-Framework.git
    source: ./Printer-Applications-Framework/
    source-type: git
    source-branch: master
    # build-environment:
    #   - DEBUG_LEVEL : "3"
    #   - CFLAGS : "-g"
    build-packages:
      - libcups2
      - libcups2-dev
      - perl
      - automake
      - autoconf
      - m4
      - libudev-dev
      - libavahi-client-dev
      - libavahi-common-dev
      - libavahi-common3
      - libavahi-client3
      - libgnutls28-dev

    stage-packages:
      - libcups2
      - libavahi-common3
      - libavahi-client3
      - udev

    override-build: |
      autoreconf
      snapcraftctl build

    after: [ippsample]
  
  qpdf:
    source: https://github.com/qpdf/qpdf/releases/download/release-qpdf-8.2.1/qpdf-8.2.1.tar.gz
    plugin: autotools
    build-packages:
        - libjpeg-dev
        - zlib1g-dev

  cups-filters:
    source: http://www.openprinting.org/download/cups-filters/cups-filters-1.21.2.tar.xz
    plugin: autotools
    configflags:
        - --with-pdftops=pdftops
        - --disable-ghostscript
        - --disable-mutool
    build-packages:
        - autoconf
        - autotools-dev
        - pkg-config
        - sharutils
        - poppler-utils
        - libglib2.0-dev
        - liblcms2-dev
        - libldap2-dev
        - libpoppler-private-dev
        - libpoppler-cpp-dev
        - libjpeg-dev
        - libpng-dev
        - libtiff5-dev
        - libijs-dev
        - zlib1g-dev
        - libfontconfig1-dev
        - libdbus-1-dev
        - libavahi-common-dev
        - libavahi-client-dev
        - libavahi-glib-dev
        - librsvg2-bin
        - liblouis-dev
        - fonts-dejavu-core
        - libcups2
    stage-packages:
        - poppler-utils
        - libasn1-8-heimdal
        - libavahi-glib1
        - libgssapi3-heimdal
        - libhcrypto4-heimdal
        - libheimbase1-heimdal
        - libheimntlm0-heimdal
        - libhx509-5-heimdal
        - libkrb5-26-heimdal
        - libldap-2.4-2
        - libroken18-heimdal
        - libsasl2-2
        - libwind0-heimdal
        - libdb5.3
        # - cups
    prime:
      - -usr/lib/cups/backend/driverless
      - -usr/lib/cups/driver/driverless
    organize: 
      usr/lib/cups/backend-available/* : usr/lib/cups/backend/
    after: [qpdf]
    
  hplip:
    plugin: autotools
    #source: https://sourceforge.net/projects/hplip/files/hplip/3.19.6/hplip-3.19.6.tar.gz
    source: ./hplip-3.19.6.tar.gz
    after: [server]
    configflags:
      - --disable-scan-build
      - --prefix=/
      - --enable-new-hpcups
      - --datadir=/usr/share/
      - --disable-gui-build
    build-packages:
      - libcups2-dev
      - libcups2
      - python2.7-dev
      - perl
      - automake
      - autoconf
      - m4
      - libusb-1.0-0-dev
      - libsnmp-dev
    build-environment:
      - "CUPS_DATADIR" : "/root/parts/ippsample/install/share/cups/"
    stage-packages:
      - python2.7
      - libcups2-dev
      - libsnmp30
      - libusb-1.0-0
      - python-dbus
    override-build: |
      patch -p0 < ../../../project/patch-prnt-snap-directory.patch
      patch -p0 < ../../../project/hpfax-snap-directories.patch
      snapcraftctl build
      cp /lib/libImageProcessor* $SNAPCRAFT_PART_INSTALL/lib/
      rm $SNAPCRAFT_PART_INSTALL/lib/libImageProcessor.so
      cd $SNAPCRAFT_PART_INSTALL/lib/ && ln -s libImageProcessor*.so libImageProcessor.so
    # prime:
    #   - -bin/hp*